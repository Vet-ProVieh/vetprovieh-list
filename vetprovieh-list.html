<!--
`vetprovieh-list`
Listing Elements for different types of Templates. Featuring Bulma.css

@demo demo/index.html
-->


<template id="vetprovieh-list">
  <link href="../../bulma/css/bulma.min.css" rel="stylesheet" type="text/css">
  <style>
    :host {
      display: block;
    }

    #loading {
      margin-top: 5px;
    }

    .loading {
      background-clip: content-box;
      background-color: rgb(224, 224, 224);
      height: 20px;
      padding: 5px;
      margin: 0px !important;
      animation-name: example;
      animation-duration: 4s;
    }

    @keyframes example {
      0% {
        background-color: rgb(224, 224, 224);
      }

      50% {
        background-color: rgb(244, 244, 244);
      }

      100% {
        background-color: rgb(224, 224, 224);
      }
    }
  </style>

  <!-- SearchControl on Top -->
  <div id="searchControl" class="control">
    <input id="search" class="input" type="text" placeholder="Bitte Suchbegriff eingeben">
  </div>

  <!-- Listing Elements here -->
  <div id="listElements" style="margin-top:20px;">

  </div>
  <div id="pager">

  </div>
  <!-- Loading Box here -->
  <div id="loading" class="is-hidden">
    <div class="content">
      <p class="loading">
      </p>
      <p class="loading">
      </p>
      <p class="loading">
      </p>
    </div>
  </div>
</template>

<script>
  (() => {
    'use strict';

    // Retrieve template from current script's document owner.
    const doc = document.currentScript.ownerDocument;
    const template = doc.querySelector('template#vetprovieh-list');

    class VetproviehList extends HTMLElement {

      /**
       * Regex to fill keys in template
       */
      static get regexTemplate() {
        return /{{([a-zA-Z0-9\.]+)}}/;
      }

      static get observedAttributes() {
        return ['src', 'pagesize'];
      }

      attributeChangedCallback(name, old, value) {
        if (old !== value) {
          this[name] = value;
        }
      }

      constructor() {
        super();

        /**
         * @type {!Object}
         * @private
         */
        this._properties = {
          endpoint: null,
          pagesize: null,
          page: 1,
          maxPage: 1,
          listTemplate: "<p>No Template found. Please define one</p>"
        };

        var listTemplate = this.querySelector("template");
        if (listTemplate) {
          this._properties.listTemplate = listTemplate.content;
        }
      }

      /** 
       * @property {string|null} src
       */
      get src() {
        return this._properties.src;
      }

      /** 
       * @property {int} pagesize
       */
      get pagesize() {
        return this._properties.pagesize;
      }

      /** 
       * @property {int} page
       */
      get page() {
        return this._properties.page;
      }

      /** 
       * @property {int} maxPage
       */
      get maxPage() {
        return this._properties.maxPage;
      }

      
      set page(val) {
        if (val !== this.page) {
          this._properties.page = val;
          this._updatePager();
        }
      }

      set maxPage(val) {
        if (val !== this.maxPage) {
          this._properties.maxPage = val;
          this._updatePager();
        }
      }

      set pagesize(val) {
        if (val) {
          val = parseInt(val);
        }
        if (val !== this.pagesize) {
          this._properties.pagesize = val;
          this._fetchDataFromServer();
        }
      }

      set src(val) {
        if (val !== this.src) {
          this._properties.src = val;
          this._fetchDataFromServer();
        }
      }

      /**
       * Input in search has Changed
       * @private
       */
      _addSearchFieldListener() {
        var searchTimer = 0;
        var value = null;
        var searchField = this.shadowRoot.querySelector("#search");
        searchField.addEventListener("keyup", (event) => {
          if (value != event.target.value) {
            clearTimeout(searchTimer);
            value = event.target.value;
            searchTimer = setTimeout((_) => {
              this._fetchDataFromServer(value);
            }, 300);
          }
        });
      }

      connectedCallback() {
        // Lazy creation of shadowRoot.
        if (!this.shadowRoot) {
          this.attachShadow({
            mode: 'open'
          }).appendChild(document.importNode(template.content, true));
        }

        this._addSearchFieldListener();
        this._fetchDataFromServer();
        this._updatePager();
      }

      // -----------------
      // PRIVATE METHODS
      // -----------------


      _updatePager() {
        console.log("pager");
        if (this.shadowRoot) {
          this.shadowRoot.querySelector("#pager").textContent = this.page + " / " + this.maxPage;
        }
      }

      /**
       * Can component fetch new data?
       * @private
       */
      get _readyToFetch() {
        return this.pagesize && this.src && this.shadowRoot;
      }

      /**
       * Loading Data from Remote-Server
       * @private
       */
      _fetchDataFromServer(searchValue = null) {
        if (this._readyToFetch) {
          var listElement = this;
          var currentPage = this.page;
          var pagesize = this.pagesize;

          listElement._toggleLoading();
          listElement._toggleList();
          listElement.shadowRoot.getElementById("listElements").innerHTML = "";

          fetch(this.src + "/index.json")
            .then(response => response.json())
            .then(data => {
              if (searchValue) {
                return data.filter((e) => VetproviehList.objectToStringDeep(e).indexOf(searchValue) >= 0);
              } else {
                return data;
              }
            })
            .then(data => {
              listElement.maxPage = Math.ceil(data.length / listElement.pagesize);
              return data;
            })
            .then(data => data.slice((currentPage - 1) * listElement.pagesize, currentPage * pagesize))
            .then(data => {
              // Attach to HTML-List
              data.forEach(element => listElement._attachToList(element, searchValue));

              // Toggle Loading & Show List
              listElement._toggleLoading();
              listElement._toggleList();
            });
        }
      }

      /**
       * Inserts Element to List
       * @private
       */
      _attachToList(element, searchValue) {
        var list = this.shadowRoot.getElementById("listElements");
        var newListItem = this._generateListItem();

        this._replacePlaceholdersInTemplate(newListItem, element);

        if (searchValue) {
          VetproviehList.markElement(newListItem, searchValue);
        }

        list.appendChild(newListItem);
      }

      /**
       * Generate new Item for List which is based on the template
       * @private
       */
      _generateListItem() {
        var newNode = document.importNode(this._properties.listTemplate, true);
        var div = document.createElement("div");
        div.appendChild(newNode);
        return div;
      }

      /**
       * Replacing Placeholders in template from the loaded element
       * @private
       */
      _replacePlaceholdersInTemplate(div, element) {
        var match = null;
        while (match = div.innerHTML.match(VetproviehList.regexTemplate)) {
          var value = VetproviehList.getValueFromObj(element, match[1]);
          value = value || "${attribute} not found";
          div.innerHTML = div.innerHTML.replace(match[0], value);
        }
      }

      /**
       * Toggeling Loading 
       * @private
       */
      _toggleLoading() {
        this._toggleElement("#searchControl", "is-loading");
        this._toggleElement("#loading");
      }

      /**
       * Toggeling List 
       */
      _toggleList() {
        this._toggleElement("#listElements");
      }

      /**
       *  Toggeling a HTML-Element
       * @param id
       * @private
       */
      _toggleElement(id, cssClass = "is-hidden") {
        var element = this.shadowRoot.querySelector(id);
        if (element.classList.contains(cssClass)) {
          element.classList.remove(cssClass);
        } else {
          element.classList.add(cssClass);
        }
      }

      // -----------------
      // CLASS METHODS
      // -----------------


      /**
       * Getting Value from JSON-Object
       * @param [object] value
       * @param [string] key
       * @return [object]
       */
      static getValueFromObj(value, key) {
        try {
          var attribute = key.split(".");
          while (attribute.length > 0) {
            value = value[attribute.shift()];
          }
          return value;
        } catch (ex) {
          return null;
        }
      }

      /**
       * Marking Element in Text
       * @param element
       * @param input
       */
      static markElement(element, input) {
        if (input != "") {
          element.innerHTML = element.innerHTML.split(input).join("<mark>" + input + "</mark>");
        }
      }

      /**
       * Object to String
       * @param [object] obj
       * @return [string]
       */
      static objectToStringDeep(obj) {
        return Object.keys(obj).map((k) => {
          if (typeof (obj[k]) == "object") {
            return VetproviehList.objectToStringDeep(obj[k]);
          } else {
            return obj[k];
          }
        }).toString()
      }
    }

    customElements.define('vetprovieh-list', VetproviehList);
  })();
</script>