<!--
`vetprovieh-list`
Listing Elements for different types of Templates. Featuring Bulma.css

@demo demo/index.html
-->


<template id="vetprovieh-list">
  <link href="../../bulma/css/bulma.min.css" rel="stylesheet" type="text/css">
  <style>
    :host {
      display: block;
    }

    #loading {
      margin-top: 5px;
    }

    .loading {
      background-clip: content-box;
      background-color: rgb(224, 224, 224);
      height: 20px;
      padding: 5px;
      margin: 0px !important;
      animation-name: example;
      animation-duration: 4s;
    }

    @keyframes example {
      0% {
        background-color: rgb(224, 224, 224);
      }

      50% {
        background-color: rgb(244, 244, 244);
      }

      100% {
        background-color: rgb(224, 224, 224);
      }
    }
  </style>
  <div class="control">
    <input class="input" type="text" placeholder="Bitte Suchbegriff eingeben">
  </div>
  <div id="listElements" class="is-hidden" style="margin-top:20px;">

  </div>
  <div id="loading">
    <div class="content">
      <p class="loading">
      </p>
      <p class="loading">
      </p>
      <p class="loading">
      </p>
    </div>
  </div>
</template>

<script>
  (() => {
    'use strict';

    // Retrieve template from current script's document owner.
    const doc = document.currentScript.ownerDocument;
    const template = doc.querySelector('template#vetprovieh-list');

    class VetproviehList extends HTMLElement {

      static get regexTemplate(){
        return /{{([a-zA-Z0-9\.]+)}}/;
      } 

      static get observedAttributes() {
        return ['src'];
      }

      attributeChangedCallback(name, old, value) {
        if (old !== value) {
          this[name] = value;
        }
      }

      constructor() {
        super();

        /**
         * @type {!Object}
         * @private
         */
        this._properties = {
          endpoint: null,
          listTemplate: "<p>No Template found. Please define one</p>"
        };

        var listTemplate = this.querySelector("template");
        if (listTemplate) {
          this._properties.listTemplate = listTemplate.content;
        }
      }

      /** 
       * @property {string|null} src
       */
      get src() {
        return this._properties.src;
      }

      set src(val) {
        if (val !== this.src) {
          this._properties.src = val;
          this._fetchDataFromServer();
          this._updateRendering();
        }
      }

      /**
       * Loading Data from Remote-Server
       */
      _fetchDataFromServer() {
        var listElement = this;
        fetch(this.src + "/index.json")
          .then(response => response.json())
          .then(data => {
            let toggled = false;
            for (let i = 0; i < data.length; i++) {
              const element = data[i];
              listElement._attachToList(element);
              if (i == 3) {
                toggled = true;
                //listElement._toggleList();
              }
            }

            listElement._toggleLoading();
            listElement._toggleList();
          });
      }

      /**
       * Inserts Element to List
       */
      _attachToList(element) {
        var list = this.shadowRoot.getElementById("listElements");
        var newListItem = this._generateListItem();

        this._replacePlaceholdersInTemplate(newListItem, element);

        list.appendChild(newListItem);
      }

      /**
       * Generate new Item for List which is based on the template
       */
      _generateListItem() {
        var newNode = document.importNode(this._properties.listTemplate, true);
        var div = document.createElement("div");
        div.appendChild(newNode);
        return div;
      }

      /**
       * Replacing Placeholders in template from the loaded element
       */
      _replacePlaceholdersInTemplate(div, element) {
        var match = null;
        while (match = div.innerHTML.match(VetproviehList.regexTemplate)) {
          var attribute = match[1];
          var value = element[attribute] || "${attribute} not found";
          div.innerHTML = div.innerHTML.replace(match[0], value);
        }
      }

      /**
       * Toggeling Loading 
       */
      _toggleLoading() {
        this._toggleElement("#loading");
      }

      /**
       * Toggeling List 
       */
      _toggleList() {
        this._toggleElement("#listElements");
      }

      /**
       *  Toggeling a HTML-Element
       * @param id
       */
      _toggleElement(id) {
        var element = this.shadowRoot.querySelector(id);
        if (element.classList.contains("is-hidden")) {
          element.classList.remove("is-hidden");
        } else {
          element.classList.add("is-hidden");
        }
      }

      connectedCallback() {
        // Lazy creation of shadowRoot.
        if (!this.shadowRoot) {
          this.attachShadow({
            mode: 'open'
          }).appendChild(document.importNode(template.content, true));
        }
        this._updateRendering();
      }

      /**
       * @private
       */
      _updateRendering() {
        // Avoid rendering when not connected.
        if (this.shadowRoot && this.isConnected) {
          // this.shadowRoot.querySelector('#src').textContent = this.src;
        }
      }
    }

    customElements.define('vetprovieh-list', VetproviehList);
  })();
</script>