<!--
`vetprovieh-list`
Listing Elements for different types of Templates. Featuring Bulma.css

@demo demo/index.html
-->


<template id="vetprovieh-list">
  <link href="../../bulma/css/bulma.min.css" rel="stylesheet" type="text/css">
  <style>
    :host {
      display: block;
    }

    #loading {
      margin-top: 5px;
    }

    .loading {
      background-clip: content-box;
      background-color: rgb(224, 224, 224);
      height: 20px;
      padding: 5px;
      margin: 0px !important;
      animation-name: example;
      animation-duration: 4s;
    }

    @keyframes example {
      0% {
        background-color: rgb(224, 224, 224);
      }

      50% {
        background-color: rgb(244, 244, 244);
      }

      100% {
        background-color: rgb(224, 224, 224);
      }
    }
  </style>
  <div id="searchControl" class="control">
    <input id="search" class="input" type="text" placeholder="Bitte Suchbegriff eingeben">
  </div>
  <div id="listElements" style="margin-top:20px;">

  </div>
  <div id="loading" class="is-hidden">
    <div class="content">
      <p class="loading">
      </p>
      <p class="loading">
      </p>
      <p class="loading">
      </p>
    </div>
  </div>
</template>

<script>
  (() => {
    'use strict';

    // Retrieve template from current script's document owner.
    const doc = document.currentScript.ownerDocument;
    const template = doc.querySelector('template#vetprovieh-list');

    class VetproviehList extends HTMLElement {

      static get regexTemplate() {
        return /{{([a-zA-Z0-9\.]+)}}/;
      }

      static get observedAttributes() {
        return ['src', 'pagesize'];
      }

      attributeChangedCallback(name, old, value) {
        if (old !== value) {
          this[name] = value;
        }
      }

      constructor() {
        super();

        /**
         * @type {!Object}
         * @private
         */
        this._properties = {
          endpoint: null,
          pagesize: null,
          listTemplate: "<p>No Template found. Please define one</p>"
        };

        var listTemplate = this.querySelector("template");
        if (listTemplate) {
          this._properties.listTemplate = listTemplate.content;
        }
      }

      /** 
       * @property {string|null} src
       */
      get src() {
        return this._properties.src;
      }

      get pagesize() {
        return this._properties.pagesize;
      }

      set pagesize(val) {
        if (val) {
          val = parseInt(val);
        }
        if (val !== this.pagesize) {
          this._properties.pagesize = val;
          this._fetchDataFromServer();
          this._updateRendering();
        }
      }

      get _searchField() {
        return this.shadowRoot.querySelector("#search");
      }

      set src(val) {
        if (val !== this.src) {
          this._properties.src = val;
          this._fetchDataFromServer();
          this._updateRendering();
        }
      }

      /**
       * Input in search has Changed
       */
      _addSearchFieldListener() {
        this._searchField.addEventListener("keyup", (event) => {
          this._fetchDataFromServer(event.target.value);
          this._updateRendering();
        });
      }

      /**
       * Unmark all quotes in text
       * @param element
       */
      static unmarkElement(element) {
        element.innerHTML = element.innerHTML.split(/<\/{0,1}mark>/).join("");
      }

      /**
       * Marking Element in Text
       * @param element
       * @param input
       */
      static markElement(element, input) {
        if (input != "") {
          element.innerHTML = element.innerHTML.split(input).join("<mark>" + input + "</mark>");
        }
      }

      /**
       * Loading Data from Remote-Server
       */
      _fetchDataFromServer(searchValue = null) {
        if (!this.pagesize || !this.src || !this.shadowRoot) {
          return;
        }

        var listElement = this;
        var searchControl = listElement.shadowRoot.querySelector("#searchControl");
        searchControl.classList.add("is-loading");

        fetch(this.src + "/index.json")
          .then(response => response.json())
          .then(data => {

            listElement._toggleLoading();
            listElement._toggleList();

            if (searchValue) {
              data = data.filter((e) => {
                return Object.keys(e).map((k) => e[k]).toString().indexOf(searchValue) >= 0
              });
            }

            listElement.shadowRoot.getElementById("listElements").innerHTML = "";
            for (let i = 0; i < data.length && i < this.pagesize; i++) {
              const element = data[i];
              listElement._attachToList(element, searchValue);
            }

            listElement._toggleLoading();
            listElement._toggleList();

            searchControl.classList.remove("is-loading");
          });
      }

      /**
       * Inserts Element to List
       */
      _attachToList(element, searchValue) {
        var list = this.shadowRoot.getElementById("listElements");
        var newListItem = this._generateListItem();

        this._replacePlaceholdersInTemplate(newListItem, element);

        if (searchValue) {
          VetproviehList.markElement(newListItem, searchValue);
        }

        list.appendChild(newListItem);
      }

      /**
       * Generate new Item for List which is based on the template
       */
      _generateListItem() {
        var newNode = document.importNode(this._properties.listTemplate, true);
        var div = document.createElement("div");
        div.appendChild(newNode);
        return div;
      }

      /**
       * Replacing Placeholders in template from the loaded element
       */
      _replacePlaceholdersInTemplate(div, element) {
        var match = null;
        while (match = div.innerHTML.match(VetproviehList.regexTemplate)) {
          var attribute = match[1];
          var value = element[attribute] || "${attribute} not found";
          div.innerHTML = div.innerHTML.replace(match[0], value);
        }
      }

      /**
       * Toggeling Loading 
       */
      _toggleLoading() {
        this._toggleElement("#loading");
      }

      /**
       * Toggeling List 
       */
      _toggleList() {
        this._toggleElement("#listElements");
      }

      /**
       *  Toggeling a HTML-Element
       * @param id
       */
      _toggleElement(id) {
        var element = this.shadowRoot.querySelector(id);
        if (element.classList.contains("is-hidden")) {
          element.classList.remove("is-hidden");
        } else {
          element.classList.add("is-hidden");
        }
      }

      connectedCallback() {
        // Lazy creation of shadowRoot.
        if (!this.shadowRoot) {
          this.attachShadow({
            mode: 'open'
          }).appendChild(document.importNode(template.content, true));
          this._addSearchFieldListener();
          this._fetchDataFromServer();
        }
        this._updateRendering();
      }

      /**
       * @private
       */
      _updateRendering() {
        // Avoid rendering when not connected.
        if (this.shadowRoot && this.isConnected) {
          // this.shadowRoot.querySelector('#src').textContent = this.src;
        }
      }
    }

    customElements.define('vetprovieh-list', VetproviehList);
  })();
</script>